#!/bin/bash
#==========================================#
#                 poshd                    #
#  https://github.com/ponyofshadows/poshd  #
#              version 0.3                 #
#==========================================#
set -e
export PO_PATH="$HOME/tmp/test/all"

. lib/object.sh
. lib/time.sh

# ----------------
## Strategies for Parsing Parameters
# 
# - Adjacent non-option parameters will be concatenated into one object
# |__ objects starting with "-e" or without preceding options -> (type:event, content, path, time, remove)
# |__ objects starting with "-p" -> (type:project, content, path, status, remove)
# |__ objects starting with "-f" -> (type:file, content, remove)
# |__ objects starting with "-b" or "-r" -> (type:disk, content, action)
# |__ objects starting with "-l" -> (type:keyword, content, period)
# - Objects call specfic functions
# |__ event -> update_event
# |__ project -> update_project
# |__ event & project -> link
# |__ disk -> backup || recover
# |__ keywords -> search
# - Some special options
# |__ "--init" 
# |__ "--debug"
# |__ "--rm"
# ----------------
current_content=""
declare -A current_object
current_object["type"]="event"
object_key_list=()
object_value_list=()
PO_DEBUG=""

if [[ "$#" == 0 ]]; then
  # equivalent to option "po -l:m"
  current_object["type"]="keywords"
  current_object["period"]=$(po_period "m")
  object_key_list+=("${!current_object[@]}")
  object_value_list+=("${current_object[@]}")
else
  for arg in "$@"; do
    if [[ ! "$arg" == -* ]]; then
      # 1. If current arg is not a option
      if [[ -n "$current_content" ]]; then
        current_content+="_$arg"
      else
        current_content="$arg"
      fi
    else  
      # 2. If current arg is a option
      # |__ 1) complete last object
      po_complete_object
      # |__ 2) Specific operations
      case "$arg" in
        -e*)
          current_object["type"]="event"
          current_object["time"]="${arg#*-e}"
          current_object["time"]="${current_object["time"]#*:}"
          current_object["time"]=$(po_date "${current_object["time"]}")
          ;;
        -p*)
          current_object["type"]="project"
          current_object["status"]="${arg#*-p}"
          current_object["status"]="${current_object["status"]#*:}"
          if [[ "${current_object["status"]}" == "rm" ]]; then
            current_object["remove"]="y"
          fi
          ;;
        -f)
          current_object["type"]="file"
          ;;
        -l*)
          current_object["type"]="keywords"
          raw_period="${arg#*-l}"
          raw_period="${raw_period#*:}"
          current_object["period"]=$(po_period "$raw_period")
          ;;
        --rm)
          current_object["remove"]="y"
          ;;
        -b)
          current_object["type"]="disk"
          current_object["action"]="backup"
          ;;
        -r)
          current_object["type"]="disk"
          current_object["action"]="recover"
          ;;
        --init)
          mkdir -p $PO_PATH/event
          mkdir -p $PO_PATH/proj
          mkdir -p $PO_PATH/.hidden_proj
          echo "The path to archive files is '$PO_PATH'"
          ;;
        --debug)
          if [[ -n "$PO_DEBUG" ]]; then
            PO_DEBUG=""
            echo "[DEBUG] debug off"
          else
            PO_DEBUG="on"
            echo "[DEBUG] debug on"
          fi
          ;;
      esac
    fi
    # DEBUG{
    #if [[ -n "$PO_DEBUG" ]]; then
     #echo "[DEBUG](po) \$arg=$arg" >&2
     #echo "[DEBUG](po) \$current_content=$current_content" >&2
    #fi
    # }DEBUG
  done
  # one more thing
  po_complete_object
fi
# DEBUG{
if [[ -n "$PO_DEBUG" ]]; then
  echo "[DEBUG](po) *** Object List ***"
  object_count=${#object_key_list[@]} 
  object_index=0
  while (( object_index < object_count )); do
    echo "--------$object_index"
    echo "${object_key_list[object_index]}"
    echo "${object_value_list[object_index]}"
    let object_index+=1
  done
  echo "--------"
fi
# }DEBUG

# ----------------
## Operate on Objects
# ----------------
declare -a current_object_keys
declare -a current_object_values

declare -a event_paths
declare -a proj_paths
declare -a file_paths

object_count=${#object_key_list[@]} 
object_index=0
while (( object_index < object_count )); do
  IFS=' ' read -r -a current_object_keys <<< "${object_key_list[object_index]}"
  IFS=' ' read -r -a current_object_values <<< "${object_value_list[object_index]}"
  let object_index+=1
  unset current_object
  declare -A current_object
  declare key_count=${#current_object_keys[@]}
  declare key_index=0
  while (( key_index < key_count )); do
    current_object["${current_object_keys[$key_index]}"]="${current_object_values[$key_index]}"
    let key_index+=1
  done
  # DEBUG{
  #if [[ -n "$PO_DEBUG" ]]; then
    #echo "[DEBUG](po) cur_key: ${!current_object[@]}"
    #echo "[DEBUG](po) cur_value: ${current_object[@]}"
  #fi
  # }DEBUG
  case "${current_object["type"]}" in 
    event)
      # Time
      if [[ "${current_object["time"]}" == "" ]]; then
        current_object["time"]=$(po_date "")
      fi
      # Does this event exist? 
      event_floders=( ${PO_PATH}/event/${current_object["time"]:0:6}[0-9][0-9]${current_object["content"]} )
      event_floder=${event_floders[0]}
      if [[ -d "$event_floder" ]]; then
        current_object["time"]=$(echo "$event_floder" | sed -n 's/.*event\/\([0-9]\{8\}\).*/\1/p')
        if [[ -n "${current_object["remove"]}" ]]; then
          rm -rf "$event_floder"
          echo "event deleted: ${current_object["time"]}${current_object["content"]}"
        else
          echo "event was created earlier today: ${current_object["time"]}${current_object["content"]}"
          if [[ -n "${current_object["path"]}" ]]; then
            mkdir -p "${event_floder}/${current_object["path"]}"
          fi
          event_paths+=("${event_floder}/${current_object["path"]}")
        fi
      else 
        if [[ "${current_object["remove"]}" == "" ]]; then
          mkdir -p "${PO_PATH}/event/${current_object["time"]}${current_object["content"]}/${current_object["path"]}"
          echo "new event: ${current_object["time"]}${current_object["content"]}"
          event_paths+=("${PO_PATH}/event/${current_object["time"]}${current_object["content"]}/${current_object["path"]}")
        fi
      fi
      ;;
    project)
      proj_floder="${PO_PATH}/proj/${current_object["content"]}"
      hidden_proj_floder="${PO_PATH}/.hidden_proj/${current_object["content"]}"
      declare proj_current_status

      if [[ -d "$proj_floder" ]]; then
        proj_current_status="active"
        echo "project exists: ${current_object["content"]}"
        if [[ "${current_object["remove"]}" ==  "y" ]]; then
          rm -rf "$proj_floder"
          echo "deleted project: ${current_object["content"]}"
        elif [[ "${current_object[status]}" == "hide" ]]; then
          mv "$proj_floder" "$hidden_proj_floder"
          proj_current_status="hide"
          echo "hide project: ${current_object["content"]}"
        fi
      elif [[ -d "$hidden_proj_floder" ]]; then
        proj_current_status="hide"
        echo "hidden project exists: ${current_object["content"]}"
        if [[ "${current_object["remove"]}" ==  "y" ]]; then
          rm -rf "$hidden_proj_floder"
          echo "deleted hidden project: ${current_object["content"]}"
        elif [[ "${current_object[status]}" == "active" ]]; then
          mv "$hidden_proj_floder" "$proj_floder"
          proj_current_status="active"
          echo "active project: ${current_object["content"]}"
        fi
      elif [[ "${current_object["remove"]}" == "y" ]]; then
        proj_current_status=""
      elif [[ "${current_object["status"]}" == "hide" ]]; then
        mkdir -p "$hidden_proj_floder"
        proj_current_status="hide"
        echo "create hidden project: ${current_object["content"]}"
      else
        mkdir -p "$proj_floder"
        proj_current_status="active"
        echo "create project: ${current_object["content"]}"
      fi

      if [[ -n "$proj_current_status" ]]; then
        if [[ "$proj_current_status" == "active" ]]; then
          mkdir -p "${proj_floder}/${current_object["path"]}"
          proj_paths+=("${proj_floder}/${current_object["path"]}")
        else
          mkdir -p "${hidden_proj_floder}/${current_object["path"]}"
          proj_paths+=("${hidden_proj_floder}/${current_object["path"]}")
        fi
      fi
      ;;
    file)
      declare does_file_exist=""
      current_files=( $(eval echo ${current_object["content"]}) )
      for current_file in "${current_files[@]}"; do
        if [[ -f "$current_file" ]]; then
          does_file_exist="y"
          if [[ "${current_object["remove"]}" == "y" ]]; then
            rm -rf "$current_file"
            echo "deleted file: $current_file"
          else
            file_paths+=("$current_file")
          fi
        fi
      done
      if [[ "$does_file_exist" == "" ]]; then
        echo "file doesn't exist: ${current_object["content"]}"
      fi
      ;;
    keywords)
      kw_event_pattern="${PO_PATH}/event/${current_object["period"]}${current_object["content"]}*"
      event_results=( $(eval echo $kw_event_pattern) )
      kw_project_pattern="${PO_PATH}/proj/*${current_object["content"]}*"
      project_results=( $(eval echo $kw_project_pattern) )
      kw_hidden_project_pattern="${PO_PATH}/.hidden_proj/*${current_object["content"]}*"
      hidden_project_results=( $(eval echo $kw_hidden_project_pattern) )
      
      echo "--------- search results --------"
      if [[ -d "${event_results[0]}" ]]; then
        for event_result in "${event_results[@]}"; do
          echo "$event_result"
        done
      fi
      if [[ -d "${project_results[0]}" ]]; then
        for project_result in "${project_results[@]}"; do
          echo "$project_result"
        done
      fi
      if [[ -d "${hidden_project_results[0]}" ]]; then
        for hidden_project_result in "${hidden_project_results[@]}"; do
          echo "$hidden_project_result"
        done
      fi
      echo "---------------------------------"
      ;;
    disk)
      if [[ -d "${current_object["content"]}" ]]; then
        if [[ "${current_object}" == "backup" ]]; then
          # `-a` = `-rlptgoD`; you can't use `-g`,`-o` or `D` unless you are root 
          rsync -rlpt -cuHE -v --progress --delete --exclude=".hidden_proj/"  "$PO_PATH" "${current_object["content"]}"    
          rsync -rlpt -cuHE -v --progress "${PO_PATH}/.hidden_proj" "${current_object["content"]}/.hidden_proj" 
        else # == "recover"
          rsync -rlpt -cuHE -v --progress "${current_object["content"]}" "$PO_PATH"
        fi
      else
        echo "path doesn't exist: ${current_object["content"]}" >&2 
      fi
      ;;
  esac
done

# DEBUG{
if [[ -n "$PO_DEBUG" ]]; then
  echo "*** File Paths ***"
  for file_path in "${file_paths[@]}"; do
    echo "$file_path"
  done
  echo "*** Event Paths ***"
  for event_path in "${event_paths[@]}"; do
    echo "$event_path"
  done
  echo "*** Proj Paths ***"
  for proj_path in "${proj_paths[@]}"; do
    echo "$proj_path"
  done
fi
# }DEBUG

if [[ -n "${file_paths[@]}" ]]; then
  if [[ -n "${event_paths[@]}" ]]; then
    if [[ -n "${proj_paths[@]}" ]]; then
      # file->proj/--(hard link)--event/
      unset moved_files
      declare -a moved_files
      for file_path in "${file_paths[@]}"; do
       mv "$file_path" "${proj_paths[0]}" 
       moved_file="${proj_paths[0]}/$(basename "$file_path")"
       moved_files+=(moved_file)
      done
      for moved_file in "${moved_files[@]}"; do
        for proj_path in "${proj_paths[@]:1}"; do
          ln "$moved_file" "$proj_path"
        done
        for event_path in "${event_paths[@]}" do
          ln "$moved_file" "$event_path"
        done
      done
    else
      # file->event/
      unset moved_files
      declare -a moved_files
      for file_path in "${file_paths[@]}"; do
        mv "$file_path" "${event_paths[0]}" 
        moved_file="${event_paths[0]}/$(basename "$file_path")"
        moved_files+=(moved_file)
      done
      for moved_file in "${moved_files[@]}"; do
        for event_path in "${event_paths[@]:1}"; do
          ln "$moved_file" "$event_path"
        done
      done
    fi
  elif [[ -n "${proj_paths[@]}" ]]; then
    # file->proj/
    unset moved_files
    declare -a moved_files
    for file_path in "${file_paths[@]}"; do
      mv "$file_path" "${proj_paths[0]}" 
      moved_file="${proj_paths[0]}/$(basename "$file_path")"
      moved_files+=(moved_file)
    done
    for moved_file in "${moved_files[@]}"; do
      for proj_path in "${proj_paths[@]:1}"; do
        ln "$moved_file" "$proj_path"
      done
    done
  fi
elif [[ -n "${event_paths[@]}" && -n "${proj_paths[@]}" ]]; then
  # proj_file--(hard link)--event/
  :
fi

